# docker-compose.yml (适用于开发环境的正确版本)

services:
  app:
    # build: 指示 Docker 从当前目录的 Dockerfile 构建镜像
    build: .
    # image: 为构建出的镜像起一个名字
    image: ai-companion-backend-image:latest
    container_name: ai_companion_app
    ports:
      - "8000:8000"
    # volumes: 启用代码实时同步和热重载，这是开发阶段的必需品！
    volumes:
      - .:/app
    env_file:
      - .env
    depends_on:
      - db
      - redis

  db:
    image: postgres:15
    container_name: ai_companion_db
    env_file:
      - .env
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    container_name: ai_companion_redis
    ports:
      - "6379:6379"

  worker:
    # build: worker 服务也必须从同一个 Dockerfile 构建，以保证环境一致
    build: .
    image: ai-companion-backend-image:latest
    container_name: ai_companion_worker
    # command: 覆盖 Dockerfile 中的默认 CMD，运行 worker 进程
    command: python -m arq app.core.arq_worker.WorkerSettings
    # volumes: worker 服务同样需要代码同步
    volumes:
      - .:/app
    env_file:
      - .env
    depends_on:
      - redis
      - db

volumes:
  postgres_data: