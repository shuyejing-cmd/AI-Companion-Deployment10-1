services:
  app:
    build: .
    image: ai-companion-backend-image:latest
    container_name: ai_companion_app
    ports:
      # å»ºè®®ç»‘å®šåˆ° 127.0.0.1ï¼Œåªå…è®¸æœ¬æœºé€šè¿‡åå‘ä»£ç†ï¼ˆå¦‚Nginxï¼‰è®¿é—®
      # å¦‚æœæ‚¨ç¡®å®šè¦ä»å…¬ç½‘ç›´æ¥è®¿é—®ï¼Œå†ä½¿ç”¨ "8000:8000"
      - "127.0.0.1:8000:8000"
    # ğŸš€ REMOVED: åˆ é™¤äº†å¼€å‘é˜¶æ®µçš„ä»£ç å®æ—¶åŒæ­¥
    # volumes:
    #   - .:/app
    env_file:
      - .env
    depends_on:
      - db
      - redis
    # ğŸš€ ADDED: æ·»åŠ äº†é‡å¯ç­–ç•¥ï¼Œå¢å¼ºå¯é æ€§
    restart: unless-stopped

  db:
    image: postgres:15
    container_name: ai_companion_db
    env_file:
      - .env
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # ğŸš€ REMOVED: åˆ é™¤äº†ä¸å¿…è¦çš„ç«¯å£æš´éœ²ï¼Œå¢å¼ºå®‰å…¨æ€§
    # ports:
    #   - "5432:5432"
    # ğŸš€ ADDED: æ·»åŠ äº†é‡å¯ç­–ç•¥
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: ai_companion_redis
    # ğŸš€ REMOVED: åˆ é™¤äº†ä¸å¿…è¦çš„ç«¯å£æš´éœ²ï¼Œå¢å¼ºå®‰å…¨æ€§
    # ports:
    #   - "6379:6379"
    # ğŸš€ ADDED: æ·»åŠ äº†é‡å¯ç­–ç•¥
    restart: unless-stopped

  worker:
    build: .
    image: ai-companion-backend-image:latest
    container_name: ai_companion_worker
    command: python -m arq app.core.arq_worker.WorkerSettings
    # ğŸš€ REMOVED: åˆ é™¤äº†å¼€å‘é˜¶æ®µçš„ä»£ç å®æ—¶åŒæ­¥
    # volumes:
    #   - .:/app
    env_file:
      - .env
    depends_on:
      - redis
      - db
    # ğŸš€ ADDED: æ·»åŠ äº†é‡å¯ç­–ç•¥
    restart: unless-stopped

volumes:
  postgres_data: